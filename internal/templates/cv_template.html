<!-- internal/templates/cv_template.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1024, initial-scale=1">
    <title>
        {{- with .PersonligInfo -}}
            {{ .Namn }} - Mitt Professionella CV 2024
        {{- end -}}
    </title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- Quill.js JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #34495e;      /* Mjukare m√∂rkbl√• */
            --secondary-color: #7f8c8d;    /* Neutral gr√• */
            --accent-color: #3498db;       /* Ljusbl√• */
            --header-gradient-start: #4b6cb7;  /* Mjukare gradient start */
            --header-gradient-end: #182848;    /* Mjukare gradient slut */
            --background-color: #f7fafc;   /* Ljus bakgrund */
            --card-background: #ffffff;    /* Vit */
            --text-color: #2d3748;        /* M√∂rkgr√• text */
            --border-color: #e2e8f0;      /* Subtil gr√§ns */
            --hover-color: #edf2f7;       /* Ljus hover */
            --success-color: #2f855a;     /* M√∂rkgr√∂n */
            --danger-color: #c53030;      /* M√∂rkr√∂d */
            --timeline-color: #a0aec0;    /* Mellangr√• f√∂r timeline */
            --shadow-color: rgba(26, 54, 93, 0.1); /* Subtil skugga */

            --border-radius: 10px;
            --card-padding: 1.8rem;
            --transition-speed: 0.3s;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);

            --header-bg-start: #f8fafc;  /* Mycket ljusare start */
            --header-bg-end: #e2e8f0;    /* Ljusgr√• slut */
            --header-text: #2d3748;      /* M√∂rkgr√• text */
            --header-subtext: #4a5568;   /* Lite ljusare text f√∂r undertitel */
        }

        body {
            background: linear-gradient(135deg, var(--background-color) 0%, #ffffff 100%);
            color: var(--text-color);
            font-family: 'Poppins', sans-serif;
            line-height: 1.7;
        }

        .cv-container {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 2.5rem;
            background: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        /* Header styling */
        .cv-header {
            background: linear-gradient(135deg, var(--header-bg-start), var(--header-bg-end));
            padding: 3rem;
            border-radius: var(--border-radius);
            margin-bottom: 2.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            color: var(--header-text);
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .profile-image-container {
            position: relative;
            width: 180px;
            height: 180px;
        }

        .profile-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform 0.3s ease;
        }

        .upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--accent-color);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .profile-image-container:hover .upload-btn {
            opacity: 1;
        }

        .profile-info {
            flex-grow: 1;
        }

        .name {
            font-size: 2.8rem;
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .title {
            font-size: 1.4rem;
            color: var(--secondary-color);
            font-weight: 400;
        }

        /* Grid layout */
        .cv-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        /* Section styling */
        .cv-section {
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            transition: transform var(--transition-speed) ease, 
                        box-shadow var(--transition-speed) ease;
        }

        .cv-section:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Timeline styling */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--timeline-color);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 1rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            border: 2px solid var(--card-background);
        }

        .timeline-content {
            background: linear-gradient(135deg, var(--card-background) 0%, var(--hover-color) 100%);
            padding: 1.8rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
        }

        .timeline-content:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        /* Skills grid */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .skill-item {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 0.8rem 1.2rem;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .skill-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color);
            border-color: var(--accent-color);
        }

        /* Contact styling */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: var(--card-background);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .contact-item:hover {
            border-color: var(--accent-color);
            transform: translateX(5px);
        }

        .contact-item i {
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        /* Controls styling */
        .item-controls {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .editable:hover .item-controls {
            opacity: 1;
        }

        .edit-icon, .delete-icon {
            cursor: pointer;
            color: var(--secondary-color);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .edit-icon:hover {
            color: var(--accent-color);
        }

        .delete-icon:hover {
            color: var(--danger-color);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .cv-grid {
                grid-template-columns: 1fr;
            }

            .profile-section {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Styling f√∂r content header och delete knappar */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .delete-card-btn {
            padding: 0.3rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .delete-card-btn:hover {
            background-color: var(--danger-color);
            color: white;
        }

        /* F√∂rtydliga delete-section knappar */
        .section-controls {
            display: flex;
            gap: 0.5rem;
        }

        .delete-section {
            color: var(--danger-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .delete-section:hover {
            transform: scale(1.1);
        }

        /* Styling f√∂r profilsektionen */
        .profile-content {
            padding: 1rem;
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .profile-content p {
            margin-bottom: 0;
            line-height: 1.8;
        }

        .profile-content .item-controls {
            margin-top: 0.5rem;
        }

        /* Styling f√∂r certifieringssektionen */
        .certification-card .timeline-content {
            padding: 1.2rem;
        }

        .certification-card h4 {
            margin-bottom: 0;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        .certifications-section .timeline-item::before {
            background: var(--accent-color);
            opacity: 0.8;
        }

        /* Styling f√∂r emojis i sektionstitlar */
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* G√∂r emojis lite st√∂rre */
        .section-title::first-letter {
            font-size: 1.4em;
            margin-right: 0.3rem;
        }

        /* Uppdatera knappstil */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            border: none;
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            box-shadow: var(--box-shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
<div class="cv-container" id="cv-content">
    <!-- Header sektion -->
    <header class="cv-header">
        <div class="profile-section">
            <div class="profile-image-container">
                {{- with .PersonligInfo -}}
                    <img src="{{ .Bild }}" alt="Din Profilbild" class="profile-img editable" data-editable="image" id="profile-img">
                {{- end -}}
                <input type="file" id="image-upload" style="display: none;">
                <button id="upload-btn" class="upload-btn"><i class="bi bi-upload"></i></button>
            </div>
            <div class="profile-info">
                {{- with .PersonligInfo -}}
                <h1 class="name editable" data-editable="text">
                    <span class="editable-text">{{ .Namn }}</span>
                    <i class="bi bi-pencil edit-icon"></i>
                    <i class="bi bi-trash delete-icon"></i>
                </h1>
                <h2 class="title editable" data-editable="text">
                    <span class="editable-text">{{ .Titel }}</span>
                    <i class="bi bi-pencil edit-icon"></i>
                    <i class="bi bi-trash delete-icon"></i>
                </h2>
                {{- end -}}
            </div>
        </div>
    </header>

    <!-- Main content grid -->
    <div class="cv-grid">
        <!-- V√§nster kolumn -->
        <div class="left-column">
            <!-- Kontakt sektion -->
            <section class="cv-section contact-section">
                <h3 class="section-title">
                    üì± Kontakt
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="kontakt"></i>
                        <i class="bi bi-trash delete-section" data-section="kontakt"></i>
                    </div>
                </h3>
                <div class="contact-list" id="kontakt-container">
                    {{- range .PersonligInfo.Kontakt -}}
                    <div class="contact-item editable" data-editable="text">
                        <div class="contact-row">
                            <span class="contact-icon">{{ .Ikon }}</span>
                            <span class="editable-text">{{ .Varde }}</span>
                        </div>
                        <div class="item-controls">
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        </div>
                    </div>
                    {{- end -}}
                </div>
            </section>

            <!-- F√§rdigheter sektion -->
            <section class="cv-section skills-section">
                <h3 class="section-title">
                    ‚≠ê F√§rdigheter
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="skills"></i>
                        <i class="bi bi-trash delete-section" data-section="skills"></i>
                    </div>
                </h3>
                <div class="skills-grid" id="skills-container">
                    {{- range $index, $fardighet := .Fardigheter -}}
                    <div class="skill-item editable" data-editable="text">
                        <span class="editable-text">{{ $fardighet }}</span>
                        <div class="item-controls">
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        </div>
                    </div>
                    {{- end -}}
                </div>
            </section>

            <!-- Spr√•k sektion -->
            <section class="cv-section languages-section">
                <h3 class="section-title">
                    üåç Spr√•k
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="languages"></i>
                        <i class="bi bi-trash delete-section" data-section="languages"></i>
                    </div>
                </h3>
                <div class="language-list" id="languages-container">
                    {{ range .Sprak }}
                    <div class="language-item editable" data-editable="text">
                        <span class="editable-text">{{ .Sprak }} - {{ .Niva }}</span>
                        <div class="item-controls">
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </section>
        </div>

        <!-- H√∂ger kolumn -->
        <div class="right-column">
            <!-- Profil sektion -->
            <section class="cv-section profile-section">
                <h3 class="section-title">
                    üë§ Profil
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="profil"></i>
                        <i class="bi bi-trash delete-section" data-section="profil"></i>
                    </div>
                </h3>
                <div class="profile-content editable" data-editable="description">
                    <p class="editable-text">{{ .Profil }}</p>
                    <div class="item-controls">
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </div>
                </div>
            </section>

            <!-- Erfarenhet sektion -->
            <section class="cv-section experience-section">
                <h3 class="section-title">
                    üíº Erfarenhet
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="experience"></i>
                        <i class="bi bi-trash delete-section" data-section="experience"></i>
                    </div>
                </h3>
                <div class="timeline" id="experience-container">
                    {{- range $index, $erfarenhet := .Arbetslivserfarenhet -}}
                    <div class="timeline-item job-card">
                        <div class="timeline-content">
                            <div class="content-header">
                                <h4 class="editable" data-editable="text">
                                    <span class="editable-text">{{ $erfarenhet.Titel }}</span>
                                    <div class="item-controls">
                                        <i class="bi bi-pencil edit-icon"></i>
                                        <i class="bi bi-trash delete-icon"></i>
                                    </div>
                                </h4>
                                <button class="btn btn-outline-danger btn-sm delete-card-btn">
                                    <i class="bi bi-trash"></i> Ta bort
                                </button>
                            </div>
                            <h5 class="editable" data-editable="text">
                                <span class="editable-text">{{ $erfarenhet.Foretag }} | {{ $erfarenhet.Period }}</span>
                                <div class="item-controls">
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                </div>
                            </h5>
                            <div class="description editable" data-editable="description">
                                <p class="editable-text">{{ range $erfarenhet.Beskrivning }}{{ . }}{{ end }}</p>
                                <div class="item-controls">
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{- end -}}
                </div>
            </section>

            <!-- Utbildning sektion -->
            <section class="cv-section education-section">
                <h3 class="section-title">
                    üéì Utbildning
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="education"></i>
                        <i class="bi bi-trash delete-section" data-section="education"></i>
                    </div>
                </h3>
                <div class="timeline" id="education-container">
                    {{- range .Utbildning -}}
                    <div class="timeline-item education-card">
                        <div class="timeline-content">
                            <div class="content-header">
                                <h4 class="editable" data-editable="text">
                                    <span class="editable-text">{{ .Examen }}</span>
                                    <div class="item-controls">
                                        <i class="bi bi-pencil edit-icon"></i>
                                        <i class="bi bi-trash delete-icon"></i>
                                    </div>
                                </h4>
                            </div>
                            <h5 class="editable" data-editable="text">
                                <span class="editable-text">{{ .Skola }} | {{ .Period }}</span>
                                <div class="item-controls">
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                </div>
                            </h5>
                            {{- if .Beskrivning -}}
                            <div class="description editable" data-editable="description">
                                {{- range .Beskrivning -}}
                                <p class="editable-text">{{ . }}</p>
                                {{- end -}}
                                <div class="item-controls">
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                </div>
                            </div>
                            {{- end -}}
                        </div>
                    </div>
                    {{- end -}}
                </div>
            </section>

            <!-- Certifieringar sektion -->
            <section class="cv-section certifications-section">
                <h3 class="section-title">
                    üèÜ Certifieringar
                    <div class="section-controls">
                        <i class="bi bi-plus-circle add-button" data-section="certifications"></i>
                        <i class="bi bi-trash delete-section" data-section="certifications"></i>
                    </div>
                </h3>
                <div class="timeline" id="certifications-container">
                    {{ range .Certifieringar }}
                    <div class="timeline-item certification-card">
                        <div class="timeline-content">
                            <div class="content-header">
                                <h4 class="editable" data-editable="text">
                                    <span class="editable-text">{{ . }}</span>
                                    <div class="item-controls">
                                        <i class="bi bi-pencil edit-icon"></i>
                                        <i class="bi bi-trash delete-icon"></i>
                                    </div>
                                </h4>
                                <button class="btn btn-outline-danger btn-sm delete-card-btn">
                                    <i class="bi bi-trash"></i> Ta bort
                                </button>
                            </div>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal f√∂r Quill Editor -->
<div class="modal fade" id="quill-modal" tabindex="-1" aria-labelledby="quillModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quillModalLabel">Redigera Beskrivning</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="St√§ng"></button>
            </div>
            <div class="modal-body">
                <div id="quill-editor" style="height: 200px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                <button type="button" class="btn btn-primary" id="save-quill-btn">Spara</button>
            </div>
        </div>
    </div>
</div>

<button id="save-pdf-btn" class="btn btn-primary">
    <i class="bi bi-file-earmark-pdf me-2"></i>Spara som PDF
    <span id="loading-indicator" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
</button>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        let quill; // Quill editor instance
        let currentElement = null; // Element som redigeras
        const quillModal = new bootstrap.Modal(document.getElementById('quill-modal'));

        // Initialize Quill editor
        quill = new Quill('#quill-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']                                         // remove formatting button
                ]
            }
        });

        // Funktion f√∂r att initiera redigering
        function initializeEditables() {
            document.querySelectorAll('.editable').forEach(el => {
                el.querySelectorAll('.edit-icon').forEach(icon => {
                    icon.addEventListener('click', function(event) {
                        event.stopPropagation();
                        const parent = this.parentElement.querySelector('.editable-text');
                        const editType = el.getAttribute('data-editable');
                        if (editType === 'description') {
                            currentElement = el.querySelector('.editable-text');
                            // Exkludera ikoner fr√•n redigeringen
                            const content = currentElement.innerHTML.trim();
                            quill.root.innerHTML = content;
                            quillModal.show();
                        } else if (editType === 'image') {
                            document.getElementById('image-upload').click();
                        } else if (editType === 'text') {
                            // Speciell hantering f√∂r kontaktf√§lt med ikoner
                            if (el.closest('#kontakt-container')) {
                                editContactField(el);
                            } else {
                                enableInlineEdit(el, editType);
                            }
                        }
                    });
                });

                el.querySelectorAll('.delete-icon').forEach(icon => {
                    icon.addEventListener('click', function(event) {
                        event.stopPropagation();
                        const textElement = icon.closest('.editable');
                        if (textElement) {
                            textElement.remove();
                        }
                    });
                });
            });

            // F√∂renkla delete-section hantering
            document.querySelectorAll('.delete-section').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const section = this.closest('section');
                    const mandatorySections = ['Kontakt', 'Profil'];
                    const sectionTitle = section.querySelector('.section-title').textContent.trim();
                    
                    if (mandatorySections.some(title => sectionTitle.includes(title))) {
                        alert('Denna sektion kan inte tas bort eftersom den √§r obligatorisk.');
                        return;
                    }
                    section.remove();
                });
            });

            // Separat hantering f√∂r remove-job-btn och remove-education-btn
            document.querySelectorAll('.remove-job-btn, .remove-education-btn').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const card = this.closest('.job-card, .education-card');
                    const cardTitle = card.querySelector('.h5').textContent.trim();
                    
                    if (confirm(`√Ñr du s√§ker p√• att du vill ta bort "${cardTitle}"?`)) {
                        card.remove();
                    }
                });
            });

            // L√§gg till event listeners f√∂r alla delete-card-btn knappar
            document.querySelectorAll('.delete-card-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const card = this.closest('.job-card, .education-card');
                    card.remove();
                });
            });
        }

        // Funktion f√∂r att hantera redigering av kontaktf√§lt med ikoner
        function editContactField(element) {
            // Hitta l√§nken och iconen
            const link = element.querySelector('a');
            const icon = element.querySelector('i.bi-trash.delete-icon');
            let href = '';
            let linkText = '';

            if (link) {
                href = link.getAttribute('href');
                linkText = link.textContent;
            } else {
                // F√∂r f√§lt utan l√§nk (email, telefon, adress)
                linkText = element.querySelector('.editable-text').textContent.trim();
            }

            // D√∂lja ikoner
            element.querySelector('.edit-icon').style.display = 'none';
            element.querySelector('.delete-icon').style.display = 'none';

            // Skapa ett formul√§r f√∂r redigering
            const form = document.createElement('div');
            if (link) {
                form.innerHTML = `
                        <div class="mb-2">
                            <label for="edit-text" class="form-label">Text</label>
                            <input type="text" id="edit-text" class="form-control" value="${linkText}">
                        </div>
                        <div class="mb-2">
                            <label for="edit-href" class="form-label">URL</label>
                            <input type="url" id="edit-href" class="form-control" value="${href}">
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="save-contact-btn">Spara</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cancel-contact-btn">Avbryt</button>
                    `;
            } else {
                form.innerHTML = `
                        <div class="mb-2">
                            <label for="edit-text" class="form-label">Text</label>
                            <input type="text" id="edit-text" class="form-control" value="${linkText}">
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="save-contact-btn">Spara</button>
                        <button type="button" class="btn btn-secondary btn-sm" id="cancel-contact-btn">Avbryt</button>
                    `;
            }

            // Ers√§tt inneh√•llet med formul√§ret
            element.innerHTML = '';
            element.appendChild(form);

            // Hantera sparande
            document.getElementById('save-contact-btn').addEventListener('click', function() {
                const newText = document.getElementById('edit-text').value.trim();
                if (link) {
                    const newHref = document.getElementById('edit-href').value.trim();
                    if (newHref) {
                        element.innerHTML = `
                                <a href="${newHref}" target="_blank">${newText}</a>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>
                            `;
                    } else {
                        element.innerHTML = `
                                <span class="editable-text">${newText}</span>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>
                            `;
                    }
                } else {
                    // F√∂r f√§lt utan l√§nk
                    element.innerHTML = `
                            <span class="editable-text">${newText}</span>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        `;
                }
                initializeEditables();
            });

            // Hantera avbryt
            document.getElementById('cancel-contact-btn').addEventListener('click', function() {
                if (link) {
                    element.innerHTML = `
                            <a href="${href}" target="_blank">${linkText}</a>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        `;
                } else {
                    element.innerHTML = `
                            <span class="editable-text">${linkText}</span>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        `;
                }
                initializeEditables();
            });
        }

        // Funktion f√∂r att aktivera inline-redigering f√∂r √∂vriga f√§lt
        function enableInlineEdit(element, editType) {
            // G√∂m ikoner om de finns
            const editIcon = element.querySelector('.edit-icon');
            const deleteIcon = element.querySelector('.delete-icon');
            if (editIcon) editIcon.style.display = 'none';
            if (deleteIcon) deleteIcon.style.display = 'none';

            // Ta bort ikoner fr√•n originalinneh√•llet
            const originalContent = element.querySelector('.editable-text').textContent.trim();
            let input;

            if (editType === 'text') {
                input = document.createElement('input');
                input.type = 'text';
                input.value = originalContent;
                input.className = 'form-control';
            } else if (editType === 'description') {
                input = document.createElement('textarea');
                input.rows = 3;
                input.className = 'form-control';
                input.value = originalContent;
            }

            if (input) {
                element.innerHTML = '';
                element.appendChild(input);
                input.focus();

                // F√∂rb√§ttrad hantering av blur och Enter-tryck
                function saveEdit() {
                    const newValue = input.value.trim();
                    if (newValue === '') {
                        element.remove();
                    } else {
                        if (editType === 'description') {
                            element.innerHTML = `
                                    <span class="editable-text">${newValue}</span>
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                `;
                        } else {
                            element.innerHTML = `
                                    <span class="editable-text">${newValue}</span>
                                    <i class="bi bi-pencil edit-icon"></i>
                                    <i class="bi bi-trash delete-icon"></i>
                                `;
                        }
                        // √Öterst√§ll ikoner
                        if (editType === 'text' || editType === 'description') {
                            if (editIcon) editIcon.style.display = '';
                            if (deleteIcon) deleteIcon.style.display = '';
                        }
                        initializeEditables();
                    }
                }

                input.addEventListener('blur', saveEdit);

                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && editType === 'text') {
                        e.preventDefault(); // F√∂rhindra ny rad i input
                        saveEdit();
                    }
                });
            }
        }

        // Event listener f√∂r Quill modal spara-knapp
        document.getElementById('save-quill-btn').addEventListener('click', function() {
            if (currentElement) {
                const newContent = quill.root.innerHTML.trim();
                // Retain the existing delete and edit icons
                currentElement.innerHTML = newContent;
                // L√§gg till ikoner igen
                currentElement.insertAdjacentHTML('afterend',
                    `<i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>`
                );
                quillModal.hide();
                currentElement = null;
                initializeEditables();
            }
        });

        // Funktion f√∂r att l√§gga till nya element eller sektioner
        function addNewElement(section) {
            let container, newElement;
            try {
                switch(section) {
                    case 'skills':
                        container = document.getElementById('skills-container');
                        if (!container) throw new Error('Skills container not found');
                        newElement = document.createElement('span');
                        newElement.className = 'badge skill-badge editable';
                        newElement.setAttribute('data-editable', 'text');
                        newElement.innerHTML = `
                            <span class="editable-text">Ny f√§rdighet</span>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        `;
                        break;
                    case 'languages':
                        container = document.getElementById('languages-container');
                        newElement = document.createElement('li');
                        newElement.className = 'editable';
                        newElement.setAttribute('data-editable', 'text');
                        newElement.innerHTML =
                            `<span class="editable-text">Nytt spr√•k - Niv√•</span>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>`;
                        break;
                    case 'experience':
                        container = document.getElementById('experience-container');
                        newElement = createJobCard();
                        break;
                    case 'education':
                        container = document.getElementById('education-container');
                        newElement = createEducationCard();
                        break;
                    case 'projects':
                        container = document.getElementById('projects-container');
                        newElement = document.createElement('li');
                        newElement.className = 'editable';
                        newElement.setAttribute('data-editable', 'text');
                        newElement.innerHTML =
                            `<span class="editable-text">Nytt projekt eller prestation</span>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>`;
                        break;
                    case 'certifications':
                        container = document.getElementById('certifications-container');
                        newElement = createCertificationCard();
                        break;
                    case 'kontakt':
                        container = document.getElementById('kontakt-container');
                        newElement = document.createElement('li');
                        newElement.className = 'editable';
                        newElement.setAttribute('data-editable', 'text');
                        newElement.innerHTML =
                            `<i class="bi bi-envelope-fill me-2"></i>
                                <span class="editable-text">Ny Kontakt</span>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>`;
                        break;
                    case 'profil':
                        container = document.querySelector('.sidebar > section:nth-child(1)'); // Anpassa efter behov
                        newElement = document.createElement('p');
                        newElement.className = 'editable';
                        newElement.setAttribute('data-editable', 'text');
                        newElement.innerHTML =
                            `<span class="editable-text">Ny profiltext</span>
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>`;
                        break;
                    case 'new_section': // F√∂r nya sektioner
                        container = document.querySelector('.row');
                        newElement = createNewSection();
                        break;
                    default:
                        alert('Ok√§nd sektion: ' + section);
                        return;
                }

                if (container && newElement) {
                    container.appendChild(newElement);
                    initializeEditables();
                } else {
                    throw new Error('Container eller element kunde inte skapas');
                }
            } catch (error) {
                console.error('Fel vid skapande av nytt element:', error);
                alert('Ett fel uppstod n√§r elementet skulle l√§ggas till. F√∂rs√∂k igen.');
            }
        }

        // Funktion f√∂r att skapa ett nytt arbetslivserfarenhetskort
        function createJobCard() {
            const card = document.createElement('div');
            card.className = 'timeline-item job-card';
            card.innerHTML = `
                <div class="timeline-content">
                    <div class="content-header">
                        <h4 class="editable" data-editable="text">
                            <span class="editable-text">Ny Erfarenhet</span>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        </h4>
                        <button class="btn btn-outline-danger btn-sm delete-card-btn">
                            <i class="bi bi-trash"></i> Ta bort
                        </button>
                    </div>
                    <h5 class="editable" data-editable="text">
                        <span class="editable-text">F√∂retag | Start√•r - Slut√•r</span>
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </h5>
                    <div class="description editable" data-editable="description">
                        <p class="editable-text">Beskrivning av arbetsuppgifter och prestationer.</p>
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </div>
                </div>`;
            
            // L√§gg till event listener f√∂r delete-card-btn
            const deleteBtn = card.querySelector('.delete-card-btn');
            deleteBtn.addEventListener('click', () => card.remove());
            
            return card;
        }

        // Funktion f√∂r att skapa ett nytt utbildningskort
        function createEducationCard() {
            const card = document.createElement('div');
            card.className = 'timeline-item education-card';
            card.innerHTML = `
                <div class="timeline-content">
                    <div class="content-header">
                        <h4 class="editable" data-editable="text">
                            <span class="editable-text">Ny Utbildning</span>
                            <i class="bi bi-pencil edit-icon"></i>
                            <i class="bi bi-trash delete-icon"></i>
                        </h4>
                        <button class="btn btn-outline-danger btn-sm delete-card-btn">
                            <i class="bi bi-trash"></i> Ta bort
                        </button>
                    </div>
                    <h5 class="editable" data-editable="text">
                        <span class="editable-text">L√§ros√§te | Start√•r - Slut√•r</span>
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </h5>
                    <div class="description editable" data-editable="description">
                        <p class="editable-text">Beskrivning av utbildningen.</p>
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </div>
                </div>`;
            
            // L√§gg till event listener f√∂r delete-card-btn
            const deleteBtn = card.querySelector('.delete-card-btn');
            deleteBtn.addEventListener('click', () => card.remove());
            
            return card;
        }

        // Funktion f√∂r att skapa en ny sektion med mall
        function createNewSection() {
            const section = document.createElement('section');
            section.className = 'mb-4';
            section.innerHTML =
                `<h2 class="h5 section-title">
                        üÜï Ny Sektion
                        <div>
                            <i class="bi bi-plus-circle add-button" data-section="new_section"></i>
                            <i class="bi bi-trash delete-section" data-section="new_section"></i>
                        </div>
                    </h2>
                    <p class="editable" data-editable="text">
                        <span class="editable-text">Ny sektionens inneh√•ll.</span>
                        <i class="bi bi-pencil edit-icon"></i>
                        <i class="bi bi-trash delete-icon"></i>
                    </p>`;
            return section;
        }

        // Funktion f√∂r att l√§gga till denna hj√§lpfunktion f√∂r att kontrollera om en sektion √§r tom
        function isSectionEmpty(section) {
            const content = section.querySelector('.card-body, ul, .d-flex');
            return content ? content.children.length === 0 : true;
        }

        // Funktion f√∂r att initiera redigeringsfunktionalitet
        initializeEditables();

        // Hantera bilduppladdning
        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('image-upload').click();
        });

        document.getElementById('image-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        // Uppdatera PDF-export funktionen
        function initializePDFSave() {
            const saveButton = document.getElementById('save-pdf-btn');
            const loadingIndicator = document.getElementById('loading-indicator');

            saveButton.addEventListener('click', async function() {
                try {
                    loadingIndicator.classList.remove('d-none');
                    saveButton.disabled = true;

                    const element = document.getElementById('cv-content');
                    const originalOverflow = document.body.style.overflow;
                    document.body.style.overflow = 'visible';

                    // Spara originalstilen f√∂r alla element som ska d√∂ljas
                    const elementsToHide = document.querySelectorAll(
                        '.edit-icon, .delete-icon, .add-button, .delete-section, .delete-card-btn, .upload-btn, .item-controls, #save-pdf-btn'
                    );
                    
                    // Spara originalstilen f√∂r varje element
                    const originalStyles = new Map();
                    elementsToHide.forEach(el => {
                        originalStyles.set(el, el.style.display);
                        el.style.display = 'none';
                    });

                    // V√§nta p√• att alla √§ndringar ska appliceras
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        windowWidth: 1024,
                        windowHeight: element.scrollHeight
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    let heightLeft = pdfHeight;
                    let position = 0;
                    const pageHeight = pdf.internal.pageSize.getHeight();

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft > 0) {
                        position = heightLeft - pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, pdfHeight);
                        heightLeft -= pageHeight;
                    }

                    await pdf.save('mitt_cv.pdf');

                } catch (error) {
                    console.error('PDF generation error:', error);
                } finally {
                    // √Öterst√§ll alla element till deras originalstil
                    elementsToHide.forEach(el => {
                        const originalStyle = originalStyles.get(el);
                        if (el.id === 'save-pdf-btn') {
                            el.style.display = 'block';
                            el.style.position = 'fixed';
                            el.style.bottom = '2rem';
                            el.style.right = '2rem';
                            el.style.zIndex = '1000';
                        } else {
                            el.style.display = originalStyle || '';
                        }
                    });

                    // √Öterst√§ll √∂vriga inst√§llningar
                    document.body.style.overflow = originalOverflow;
                    loadingIndicator.classList.add('d-none');
                    saveButton.disabled = false;

                    // √Öterinitiera redigeringsfunktionaliteten
                    initializeEditables();
                }
            });
        }

        initializePDFSave();

        document.addEventListener('click', function(e) {
            // Hantering av add-button
            if (e.target && e.target.classList.contains('add-button')) {
                const section = e.target.getAttribute('data-section');
                addNewElement(section);
            }
        });

        // L√§gg till i createCertificationCard-funktionen
        function createCertificationCard() {
            const card = document.createElement('div');
            card.className = 'timeline-item certification-card';
            card.innerHTML = `
                <div class="timeline-content">
                    <div class="content-header">
                        <h4 class="editable" data-editable="text">
                            <span class="editable-text">Ny Certifiering</span>
                            <div class="item-controls">
                                <i class="bi bi-pencil edit-icon"></i>
                                <i class="bi bi-trash delete-icon"></i>
                            </div>
                        </h4>
                        <button class="btn btn-outline-danger btn-sm delete-card-btn">
                            <i class="bi bi-trash"></i> Ta bort
                        </button>
                    </div>
                </div>`;
            
            // L√§gg till event listener f√∂r delete-card-btn
            const deleteBtn = card.querySelector('.delete-card-btn');
            deleteBtn.addEventListener('click', () => card.remove());
            
            return card;
        }

    });
</script>
</body>
</html>
